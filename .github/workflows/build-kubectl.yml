name: Build

on:
  workflow_call:
    inputs:
      tags:
        type: string
        description: The Docker Tags (see docker/metadata-action@v4 for available values)
        required: true

jobs:
  skopeo:
    name: kubectl_versions
    runs-on: ubuntu-latest
    outputs:
      kubectl_versions: ${{Â toJSON(steps.kubectl_versions.ouputs.kubectl_versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: 'Set up skopeo'
        uses: warjiang/setup-skopeo@main
        with:
          version: latest

      - name: 'versions'
        id: kubectl_versions
        run: |
         python --version
         export ALL_VERSIONS=$(skopeo  list-tags   docker://registry.k8s.io/kubectl | jq -r '.Tags | .[]|  select(. | match("v[0-9].[0-9]{2}.[0-9]$"))')
         export VERSIONS=$(python ./get_kubectl_versions.py)
         echo ${VERSIONS}
         echo "kubectl_versions=\'${VERSIONS}\'" >> $GITHUB_OUTPUT   
         cat $GITHUB_OUTPUT


  build-kubectl:
   runs-on: ubuntu-latest
   needs: ["skopeo"]
   strategy:
     matrix:
       tag: ${{ fromJSON(needs.skopeo.outputs.kubectl_versions.tags) }}
   steps:
   - name: Build-kubetcl-with-shell
     uses: coopTilleuls/action-docker-build-push@custom-tags
     with:
       IMAGE_NAME: kubectl
       BUILD_CONTEXT: ./kubectl
       BUILD_ARGS:  ${{needs.skopeo.outputs.kubectl_versions.versions[matrix.tag] }}
       BUILD_TARGET: debian-kubectl
       REGISTRY_JSON_KEY: ${{ secrets.GITHUB_TOKEN }}
       IMAGE_REPOSITORY: ghcr.io/cooptilleuls/sre
       CUSTOM_TAG:  ${{ matrix.tag }}





