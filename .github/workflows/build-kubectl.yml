name: Build

on:
  workflow_call:
    inputs:
      tags:
        type: string
        description: The Docker Tags (see docker/metadata-action@v4 for available values)
        required: true

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.data.outputs.versions }}
      tags: ${{ steps.data.outputs.tags }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: 'Set up skopeo'
        uses: warjiang/setup-skopeo@main
        with:
          version: latest
      - id: data
        run: |
         python --version
         export ALL_VERSIONS=$(skopeo  list-tags   docker://registry.k8s.io/kubectl | jq -r '.Tags | .[]|  select(. | match("v[0-9].[0-9]{2}.[0-9]$"))')
         python ./get_kubectl_versions.py >  data.json
         echo "versions=$(cat data.json )" >> "$GITHUB_OUTPUT"
         echo "tags=$(cat data.json | jq -c 'keys')"  >> "$GITHUB_OUTPUT"
  build-kubectl:
    runs-on: ubuntu-latest
    needs: fetch-data
    strategy:
      matrix:
        tag: ${{ fromJSON(needs.fetch-data.outputs.tags) }}
    steps:
      - name: test
        run: echo "$OUTPUT1 $OUTPUT2 ${{matrix.tag}}"
      - name: data
        run: |
          KUBECTL_VERSION=$(echo '${{needs.fetch-data.outputs.versions }}' | jq --arg KEY "${{ matrix.tag }}" '.[$KEY]') 
          echo "build_args=KUBECTL_VERSION=$KUBECTL_VERSION" >> "$GITHUB_OUTPUT"
          echo $GITHUB_OUTPUT
      - name: Build-kubetcl-with-shell
        uses: coopTilleuls/action-docker-build-push@custom-tags
        with:
          IMAGE_NAME: kubectl
          BUILD_CONTEXT: ./kubectl
          BUILD_ARGS: ${{ steps.data.build_args }}
          BUILD_TARGET: debian-kubectl
          REGISTRY_JSON_KEY: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_REPOSITORY: ghcr.io/cooptilleuls/sre
          CUSTOM_TAG: ${{ matrix.tag }}






