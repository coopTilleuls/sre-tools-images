name: CD
on:
  pull_request: 
    types: [ opened, synchronize, reopened, labeled ]
  push:
    branches:
      - main
      - k8s-versions
    tags:
      - '*'

jobs:
  remove-deploy-label:
    name: Remove deploy label
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'deploy')
    runs-on: ubuntu-latest
    steps:
      - uses: mondeja/remove-labels-gh-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          labels: |
            deploy

  skopeo:
    name: kubectl_versions
    runs-on: ubuntu-latest
    output:
      kubectl_versions=${{Â steps.kubectl_versions.ouputs.kubectl_versions }}
    steps:
      - name: 'Set up skopeo'
        uses: warjiang/setup-skopeo@main
        with:
          version: latest

      - name: 'versions'
        id: kubectl_versions
        run: |
         VERSION=$(skopeo  list-tags   docker://registry.k8s.io/kubectl | jq -r '.Tags | .[]|  select(. | match("v[0-9].[0-9]{2}.[0-9]$"))' | \
            | sort | awk -F"."  '$2>31{split($0,a,"."); ret[a[2]] = $0" "  }END{for (i=0 ; i<length(ret); i++sd ) { printf ret[i] }}' )
         echo "kubectl_versions=${VERSIONS} >> $GITHUB_OUTPUT   
         python --version


#build:
  #  name: Build
  #  if: github.event_name != 'pull_request' || (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'deploy'))
  #  uses: ./.github/workflows/build.yml
  #  with:
  #    tags: |
  #      type=ref,event=branch
  #      type=ref,event=pr
  #      type=ref,event=tag
  #      type=semver,pattern={{version}}
  #      type=semver,pattern={{major}}.{{minor}}
  #      type=sha
